<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Runner: Salta Obstacles</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b1020; color: #e8ecff; display: grid; place-items: center; min-height: 100vh; }
    .wrap { width: min(920px, 96vw); }
    header {
      display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .title { display: flex; align-items: baseline; gap: 10px; }
    h1 { margin: 0; font-size: 20px; }
    .hint { font-size: 13px; color: #b9c2ff; opacity: .9; }
    .hud { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: flex-end; }
    .pill {
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
    }
    .btn {
      background: #4f7cff; border: 0; color: white; font-weight: 700;
      padding: 8px 12px; border-radius: 12px; cursor: pointer;
    }
    .btn.secondary { background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.16); }
    .btn:disabled { opacity: .55; cursor: not-allowed; }
    canvas {
      width: 100%; height: auto;
      background: radial-gradient(1200px 500px at 50% 0%, rgba(79,124,255,.25), transparent 55%),
                  linear-gradient(#0b1020, #070a14);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display: block;
    }
    .panel {
      margin-top: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 12px 14px;
      display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: space-between;
    }
    .panel .left { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    select {
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      color: #e8ecff;
      padding: 7px 10px;
      border-radius: 12px;
      outline: none;
      font-weight: 600;
    }
    .msg { font-size: 13px; color: #c9d0ff; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16); padding: 2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>üèÉ Runner: Salta Obstacles</h1>
      <div class="hint">Salta i evita els blocs. Com m√©s temps, m√©s r√†pid.</div>
    </div>
    <div class="hud">
      <div class="pill">Punts: <b id="score">0</b></div>
      <div class="pill">Millor: <b id="best">0</b></div>
      <div class="pill">Vides: <b id="lives">3</b></div>
      <button class="btn secondary" id="pauseBtn" title="Pausa/Continua (P)">Pausa</button>
      <button class="btn" id="startBtn">Comen√ßa</button>
    </div>
  </header>

  <canvas id="game" width="920" height="380" aria-label="Joc runner"></canvas>

  <div class="panel">
    <div class="left">
      <label>
        Dificultat:
        <select id="difficulty">
          <option value="easy">F√†cil</option>
          <option value="normal" selected>Normal</option>
          <option value="hard">Dif√≠cil</option>
          <option value="insane">Ins√†</option>
        </select>
      </label>
      <div class="msg">
        Controls: <span class="kbd">Espai</span>/<span class="kbd">‚Üë</span> saltar ¬∑ <span class="kbd">‚Üì</span> ajupir-se ¬∑ <span class="kbd">P</span> pausa ¬∑ <span class="kbd">R</span> reinicia
      </div>
    </div>
    <div>
      <button class="btn secondary" id="resetBtn">Reinicia</button>
    </div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  const scoreEl = document.getElementById("score");
  const bestEl  = document.getElementById("best");
  const livesEl = document.getElementById("lives");
  const startBtn = document.getElementById("startBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const resetBtn = document.getElementById("resetBtn");
  const diffSel = document.getElementById("difficulty");

  const W = canvas.width, H = canvas.height;
  const groundY = H - 70;

  const bestKey = "runner_best_v1";
  let best = Number(localStorage.getItem(bestKey) || "0");
  bestEl.textContent = best;

  // Config per dificultat
  const DIFF = {
    easy:   { baseSpeed: 260, spawnEvery: 1.35, accel: 10,  lives: 4, obstacleScale: 0.95 },
    normal: { baseSpeed: 320, spawnEvery: 1.15, accel: 16,  lives: 3, obstacleScale: 1.00 },
    hard:   { baseSpeed: 380, spawnEvery: 1.00, accel: 22,  lives: 2, obstacleScale: 1.10 },
    insane: { baseSpeed: 440, spawnEvery: 0.85, accel: 28,  lives: 1, obstacleScale: 1.20 },
  };

  // Estat del joc
  let running = false;
  let paused = false;
  let gameOver = false;

  let t = 0;            // temps acumulat
  let dt = 0;           // delta temps
  let last = 0;         // timestamp anterior
  let score = 0;
  let lives = 3;

  // Part√≠cules d'impacte
  const particles = [];

  // Jugador
  const player = {
    x: 120,
    y: groundY,
    w: 34,
    h: 54,
    vy: 0,
    onGround: true,
    crouch: false,
    invuln: 0, // segons d'invulnerabilitat post-impacte
  };

  // Obstacles
  const obstacles = [];
  let spawnTimer = 0;

  function cfg() { return DIFF[diffSel.value] || DIFF.normal; }

  function reset(all = true) {
    running = false;
    paused = false;
    gameOver = false;
    t = 0;
    score = 0;
    scoreEl.textContent = "0";
    obstacles.length = 0;
    particles.length = 0;
    spawnTimer = 0;

    const c = cfg();
    lives = c.lives;
    livesEl.textContent = String(lives);

    player.y = groundY;
    player.vy = 0;
    player.onGround = true;
    player.crouch = false;
    player.invuln = 0;

    if (all) drawSplash("Prem ¬´Comen√ßa¬ª o ESPAI");
  }

  function start() {
    if (running) return;
    running = true;
    paused = false;
    gameOver = false;
    last = performance.now();
    requestAnimationFrame(loop);
  }

  function endGame() {
    gameOver = true;
    running = false;
    paused = false;

    if (score > best) {
      best = score;
      localStorage.setItem(bestKey, String(best));
      bestEl.textContent = String(best);
    }
    drawOverlay(`üí• Game Over`, `Punts: ${score} ¬∑ Millor: ${best} ¬∑ Prem R o Reinicia`);
  }

  function jump() {
    if (!running || paused || gameOver) return;
    if (player.onGround) {
      player.vy = -620;
      player.onGround = false;
      puff(player.x + 10, player.y + player.h, 10);
    }
  }

  function setCrouch(v) {
    player.crouch = v;
  }

  function spawnObstacle(speed) {
    const c = cfg();
    const scale = c.obstacleScale;

    // tipus: alt, baix (cal ajupir-se), doble petit
    const r = Math.random();
    let type = "tall";
    if (r > 0.68 && r <= 0.88) type = "low";
    if (r > 0.88) type = "tiny2";

    let obs = { x: W + 30, y: groundY, w: 30, h: 46, vx: speed, passed: false, kind: type };

    if (type === "tall") { obs.w = 32 * scale; obs.h = 52 * scale; obs.y = groundY; }
    if (type === "low")  { obs.w = 58 * scale; obs.h = 18 * scale; obs.y = groundY + 18; } // "volant" baix
    if (type === "tiny2"){ obs.w = 18 * scale; obs.h = 26 * scale; obs.y = groundY; obs.gap = 28; } // dos petits

    obstacles.push(obs);
  }

  function puff(x, y, n = 14) {
    for (let i = 0; i < n; i++) {
      particles.push({
        x, y,
        vx: (Math.random() - 0.5) * 220,
        vy: -Math.random() * 220,
        life: 0.6 + Math.random() * 0.5
      });
    }
  }

  function rectsOverlap(a, b) {
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  function playerRect() {
    const h = player.crouch ? 34 : player.h;
    const y = player.crouch ? (groundY + (player.h - h)) : player.y;
    return { x: player.x, y, w: player.w, h };
  }

  function loop(now) {
    if (!running) return;

    dt = Math.min(0.033, (now - last) / 1000);
    last = now;

    if (!paused) {
      t += dt;
      update(dt);
      render();
    } else {
      render(); // mantenim el frame
      drawOverlay("‚è∏ Pausa", "Prem P per continuar");
    }

    requestAnimationFrame(loop);
  }

  function update(dt) {
    const c = cfg();
    const speed = c.baseSpeed + c.accel * t;

    // Puntuaci√≥: puja amb el temps i amb obstacles esquivats
    score += Math.floor(12 * dt + (speed / 1000) * 2);
    scoreEl.textContent = String(score);

    // Gravetat i jugador
    const g = 1700;
    player.vy += g * dt;
    player.y += player.vy * dt;

    if (player.y >= groundY) {
      player.y = groundY;
      player.vy = 0;
      player.onGround = true;
    }

    // Invulnerabilitat post-cop
    if (player.invuln > 0) player.invuln = Math.max(0, player.invuln - dt);

    // Spawn obstacles
    spawnTimer += dt;
    const every = c.spawnEvery;
    if (spawnTimer >= every) {
      spawnTimer = 0;
      spawnObstacle(speed);
      // mica de variaci√≥
      spawnTimer -= Math.random() * 0.35;
    }

    // Moure obstacles i detectar col¬∑lisions
    const pr = playerRect();

    for (let i = obstacles.length - 1; i >= 0; i--) {
      const o = obstacles[i];
      o.x -= speed * dt;

      // Si √©s "tiny2", comptem tamb√© el segon bloc
      const rects = [ { x:o.x, y:o.y, w:o.w, h:o.h } ];
      if (o.kind === "tiny2") rects.push({ x:o.x + o.w + o.gap, y:o.y, w:o.w, h:o.h });

      // Marcar passat per sumar punts extra
      if (!o.passed && o.x + o.w < player.x) {
        o.passed = true;
        score += 35;
        scoreEl.textContent = String(score);
      }

      // Col¬∑lisi√≥
      if (player.invuln <= 0) {
        for (const r of rects) {
          if (rectsOverlap(pr, r)) {
            lives -= 1;
            livesEl.textContent = String(lives);
            player.invuln = 1.1;
            puff(pr.x + pr.w/2, pr.y + pr.h/2, 22);

            if (lives <= 0) return endGame();
            break;
          }
        }
      }

      // fora pantalla
      const rightMost = (o.kind === "tiny2") ? (o.x + o.w*2 + o.gap) : (o.x + o.w);
      if (rightMost < -80) obstacles.splice(i, 1);
    }

    // Part√≠cules
    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.life -= dt;
      p.vy += 800 * dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      if (p.life <= 0) particles.splice(i, 1);
    }
  }

  function drawBackground(speed) {
    // l√≠nies "ne√≥" i parallax senzill
    ctx.clearRect(0, 0, W, H);

    // estrelles
    ctx.globalAlpha = 0.9;
    for (let i = 0; i < 60; i++) {
      const x = (i * 173 + (t * speed * 0.08)) % W;
      const y = (i * 97) % (H - 120) + 20;
      ctx.fillStyle = "rgba(255,255,255,.35)";
      ctx.fillRect(W - x, y, 2, 2);
    }

    // "horiz√≥"
    ctx.globalAlpha = 1;
    ctx.fillStyle = "rgba(255,255,255,.08)";
    ctx.fillRect(0, groundY + 54, W, 2);

    // terra
    ctx.fillStyle = "rgba(255,255,255,.06)";
    ctx.fillRect(0, groundY + 56, W, H - (groundY + 56));

    // l√≠nies de moviment
    ctx.globalAlpha = 0.45;
    for (let i = 0; i < 18; i++) {
      const x = (i * 90 + (t * speed * 0.55)) % (W + 200) - 200;
      ctx.fillStyle = "rgba(79,124,255,.25)";
      ctx.fillRect(W - x, groundY + 60, 36, 2);
    }
    ctx.globalAlpha = 1;
  }

  function render() {
    const c = cfg();
    const speed = c.baseSpeed + c.accel * t;

    drawBackground(speed);

    // Obstacles
    for (const o of obstacles) {
      drawObstacle(o);
    }

    // Part√≠cules
    for (const p of particles) {
      ctx.globalAlpha = Math.max(0, Math.min(1, p.life));
      ctx.fillStyle = "rgba(255,255,255,.65)";
      ctx.fillRect(p.x, p.y, 3, 3);
    }
    ctx.globalAlpha = 1;

    // Jugador
    drawPlayer();

    // Barra de progr√©s de velocitat
    const v = Math.min(1, (speed - c.baseSpeed) / 600);
    ctx.fillStyle = "rgba(255,255,255,.10)";
    ctx.fillRect(18, 18, 220, 10);
    ctx.fillStyle = "rgba(79,124,255,.85)";
    ctx.fillRect(18, 18, 220 * v, 10);
    ctx.fillStyle = "rgba(255,255,255,.70)";
    ctx.font = "12px system-ui, sans-serif";
    ctx.fillText("Velocitat", 18, 44);

    // Missatge si invulnerable
    if (player.invuln > 0) {
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = "rgba(255,120,120,.35)";
      ctx.fillRect(0, 0, W, H);
      ctx.globalAlpha = 1;
    }
  }

  function drawPlayer() {
    const r = playerRect();
    // cos
    ctx.fillStyle = "rgba(255,255,255,.92)";
    ctx.fillRect(r.x, r.y, r.w, r.h);

    // ull
    ctx.fillStyle = "rgba(11,16,32,.9)";
    ctx.fillRect(r.x + r.w - 10, r.y + 10, 4, 4);

    // ombra
    ctx.globalAlpha = 0.5;
    ctx.fillStyle = "rgba(0,0,0,.6)";
    ctx.beginPath();
    ctx.ellipse(r.x + r.w/2, groundY + 60, r.w*0.65, 10, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  function drawObstacle(o) {
    const drawRect = (x,y,w,h) => {
      ctx.fillStyle = "rgba(79,124,255,.85)";
      ctx.fillRect(x, y, w, h);
      ctx.fillStyle = "rgba(255,255,255,.35)";
      ctx.fillRect(x+3, y+3, Math.max(0, w-6), 4);
    };

    drawRect(o.x, o.y, o.w, o.h);

    if (o.kind === "tiny2") {
      drawRect(o.x + o.w + o.gap, o.y, o.w, o.h);
    }
    if (o.kind === "low") {
      // petit efecte "brillantor"
      ctx.globalAlpha = 0.6;
      ctx.fillStyle = "rgba(255,255,255,.18)";
      ctx.fillRect(o.x, o.y - 6, o.w, 4);
      ctx.globalAlpha = 1;
    }
  }

  function drawSplash(text) {
    render();
    drawOverlay("üëã Preparat/da?", text);
  }

  function drawOverlay(title, subtitle) {
    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,.55)";
    ctx.fillRect(0, 0, W, H);

    ctx.fillStyle = "rgba(255,255,255,.95)";
    ctx.font = "700 30px system-ui, sans-serif";
    ctx.textAlign = "center";
    ctx.fillText(title, W/2, H/2 - 10);

    ctx.fillStyle = "rgba(255,255,255,.80)";
    ctx.font = "16px system-ui, sans-serif";
    ctx.fillText(subtitle, W/2, H/2 + 22);

    ctx.fillStyle = "rgba(255,255,255,.65)";
    ctx.font = "13px system-ui, sans-serif";
    ctx.fillText("Consell: ajup-te (‚Üì) per evitar obstacles baixos.", W/2, H/2 + 52);
    ctx.restore();
  }

  // Controls teclat
  const keys = new Set();
  window.addEventListener("keydown", (e) => {
    if (["Space","ArrowUp","ArrowDown","KeyP","KeyR"].includes(e.code)) e.preventDefault();
    keys.add(e.code);

    if (e.code === "Space" || e.code === "ArrowUp") {
      if (!running && !gameOver) start();
      jump();
    }
    if (e.code === "ArrowDown") setCrouch(true);

    if (e.code === "KeyP") togglePause();
    if (e.code === "KeyR") { reset(false); start(); }
  }, { passive: false });

  window.addEventListener("keyup", (e) => {
    keys.delete(e.code);
    if (e.code === "ArrowDown") setCrouch(false);
  });

  // Controls botons
  startBtn.addEventListener("click", () => start());
  pauseBtn.addEventListener("click", () => togglePause());
  resetBtn.addEventListener("click", () => { reset(false); start(); });

  diffSel.addEventListener("change", () => {
    // reinici net amb noves vides/config
    reset(true);
  });

  function togglePause() {
    if (!running || gameOver) return;
    paused = !paused;
    pauseBtn.textContent = paused ? "Continua" : "Pausa";
  }

  // Inicial
  reset(true);
})();
</script>
</body>
</html>
